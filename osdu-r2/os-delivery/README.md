# OSDU R2 Prototype Delivery service

## Table of contents

* [Introduction](#introduction)
* [System interactions](#system-interactions)
* [Validations](#validations)
* [API](#delivery-api)
    * [POST /delivery](#post-delivery)
    * [POST /getLocation](#post-getlocation)
    * [POST /getFileLocation](#post-getfilelocation)
    * [POST /getFileList](#post-getfilelist)
* [Service Provider Interfaces](#service-provider-interfaces)
* [GCP implementation](#gcp-implementation)
* [Datastore](#datastore)
* [Firestore](#firestore-collections)

## Introduction

The OSDU R2 Delivery service provides internal and external API endpoints to let the application or
user fetch any records from the system or request file location data.  For example, users can
request generation of an individual signed URL per file. Using a signed URL, OSDU R2 users will be
able to upload their files to the system.

The current implementation of the Delivery service supports only cloud platform-specific locations.
The future implementations might allow the use of on-premises locations.

## System interactions

The Delivery service defines the following workflows:

* Delivery
* File upload
* File location delivery
* File list delivery

### Delivery

The delivery workflow is defined for the `/delivery` API endpoint. The user or application needs to
start this workflow when they need to obtain OSDU data from the system. The OSDU data can include
Master Data, Reference Data, Work Product, Work Product Component, or File.

Upon a `/delivery` request:

1. Verify the incoming request.
    * Verify the authentication token. Fail delivery if the token is missing or invalid, and then
    respond with the `401 Unauthorized` status.
    * Verify the partition ID. Fail delivery if the partition ID is missing or invalid or doesn't
    have assigned user groups, and then respond with the `400 Bad Request` status.
2. For each SRN in the request:
   * Find the _SRN to DELFI record ID_ mapping in the database.
       * If there's no record for the current SRN in the database, set the processing result status
       to `NO_MAPPING` for this SRN, and then return the result.
   * From the found mapping, get the DELFI record ID for the current SRN, and then query DELFI with
   this ID.
   * Determine whether the record returned by DELFI contains _file_ or _data_. Perform one of the
   following processes on the record:
       * If the record contains a URL to a file, query the system to get the signed URL for the
       file, and then:
           * Set the processing result status to `FILE` for this SRN.
           * Set the data retrieved from the record.
           * Set the `FileLocation` property to the signed URL generated by DELFI.
       * If the record doesn't contain a URL, this record only contains data. Carry out the
       following actions:
           * Set the data retrieved from the record.
           * Set the processing result status to `DATA`.
   * Add the record data that came from the record's `osdu` property to the response object.
   * Add the file URL from the record data to the `FileLocation` property of the response object.
3. Return the obtained data to the requester. The unprocessed SRNs are added to the
`unprocessedSrns` property in the response body.

### File upload

The file upload workflow is defined for the `/getLocation` API endpoint. The following diagram
illustrates the workflow.

![OSDU_R2_Delivery_Service_getLocation](/uploads/a83ea229ca0cef81344a916e74ee2096/OSDU_R2_Delivery_Service_getLocation.png)

Upon a request to get a location for a file:

1. Verify the incoming request.
    * Verify the authentication token. Fail signed URL generation if the token is missing or
    invalid, and then respond with the `401 Unauthorized` status.
    * Verify the partition ID. Fail signed URL generation if the partition ID is missing, invalid or
    doesn't have assigned user groups, and then respond with the `400 Bad Request` status.
    * Verify the file ID if it's passed in the request body. Fail signed URL generation if the file
    ID is invalid or if this ID has already been created. Respond with `400 Bad Request` status
    and the `Location for fileID {ID} already exists` message.
2. Generate a new Universally Unique Identifier (UUID) for the file if a file ID wasn't provided.
3. Create an empty object in storage, and then generate a signed URL with the write access for that
object. By the signed URL, the user or application will upload their file for ingestion. The
generated signed URL has a maximum duration of 7 days.
    * By the signed URL, the user or application will upload their file.
    * The generated signed URL has the maximum duration of 7 days.
    > How signed URLs are generated depends on the cloud platform.
4. Create a record with file data in the database. The record will contain a key-value pair with the
file ID as the key and object as the value. For more information on the record, consult the
[Firestore](#firestore-collections) section.
5. Return the signed URL and file ID to the application or user.

### File location delivery

The file location delivery workflow is defined for the `/getFileLocation` API endpoint. The
following diagram demonstrates the workflow.

![OSDU R2 Delivery Service getFileLocation](/uploads/f68011126933398f196e3d0066a9335d/OSDU_R2_Delivery_Service_getFileLocation.png)

Upon request from an OSDU R2 service:

1. Validate the incoming request.
    * Verify the authentication token. Fail file location delivery if the token is missing or
    invalid, and then respond with the `401 Unauthorized` status.
    * Verify the partition ID. Fail file location delivery if the partition ID is missing, invalid
    or doesn't have assigned user groups, and then respond with the `400 Bad Request` status.
2. Query the database with the `FileID` to get the file record.
3. Return the `Location` and `Driver` from the file record to the calling service.

### File list delivery

The file list delivery workflow is defined for the `/getFileList` API endpoint.

Upon request from another OSDU R2 service:

1. Verify the incoming request.
    * Verify the authentication token. Fail file list delivery if the token is missing or invalid,
    and then respond with the `401 Unauthorized` status.
    * Verify the partition ID. Fail file list delivery if the partition ID is missing, invalid or
    doesn't have assigned user groups, and then respond with the `400 Bad Request` status.
    * Validate the file list request.
2. Obtain the requested files from the database.
3. Return the result to the caller.

## Database interactions

During each workflow, the Delivery service queries the database. For more information about the file
records in the database, consult the [file-locations collection](#firestore-collections) section.

## Validations

The Delivery service's current implementation performs a general check of the validity of the
authorization token and DELFI partition ID before the service starts generation of a location.

However, the Delivery service in the OSDU R2 Prototype doesn't perform any verification whether a
file upload happened or whether the user started ingestion after uploading a file. In future OSDU
implementations, the Delivery service will be able to check if file uploads did happen.

## Delivery API

The Delivery service's API includes the following three methods in the OSDU R2 Prototype:

* `/delivery`, external
* `/getLocation`, external
* `/getFileLocation`, internal
* `/getFileList`, internal

General considerations related to querying the Delivery API:

* Each endpoint must receive the authentication bearer token in the "Authorization" header. Example:
`"Authorization": "Bearer {token}"`
* Each endpoint must receive a DELFI partition ID in header. Example:
`"Partition-Id": "default-partition"`
* The request and response Content Type is **application/json**

### POST /delivery

The `/delivery` API endpoint delivers a list of records with OSDU data retrieved from the system
and, if no records were found for some SRNs, a list of unprocessed SRNs.

#### Request body

A delivery request contains a list of SRNs of the OSDU Master Data, Reference Data, Work Product,
Work Product Component, or File that the user wants to obtain from the system. If the client wants
to deliver a Work Product with full data for all related Work Product Components and Files, all
related SRNs for WPCs and Files must also be included in the list.

| Property       | Type     | Description          |
| -------------- | -------- | -------------------- |
| SRNS           | `List`   | A list of SRNs       |
| TargetRegionID | `String` | The target region ID |

Example request for master data:

```sh
curl --location --request POST 'https://{path}/delivery' \
    --header 'Authorization: Bearer {token}' \
    --header 'Content-Type: application/json' \
    --header 'Partition-Id: {assigned DELFI partition ID}' \
    --data-raw '{
      "SRNS": ["srn:master-data/Wellbore:2221:"],
      "TargetRegionID": "test"
    }'
```

Example request for a file:

```sh
curl --location --request POST 'https://{path}/delivery' \
    --header 'Authorization: Bearer {token}' \
    --header 'Content-Type: application/json' \
    --header 'Partition-Id: {assigned DELFI partition ID}' \
    --data-raw '{
      "SRNS": ["srn:file/las2:c589ade1b53111e99047c99b225c8828:1"],
      "TargetRegionID": "test"
    }'
```

#### Response body

The output from the `/delivery` endpoint is a list of results for the given list of SRNs. This list
may also contain links to download locations such as Google Cloud Storage if any of the given SRNs
is associated with a file.

Response body for a master data request:

```json
{
  "UnprocessedSRNs": [],
  "Result": [
  {
    "Data": {
      "GroupTypeProperties": {},
      "IndividualTypeProperties": {
        "BottomHoleLocation": {
          "MeasuredDepthUOMID": "srn:reference-data/UnitOfMeasure:M:",
          "GeographicCoordinates": [{
            "X": 53.1488564,
            "Y": 5.77885285
          }],
          "VerticalCRSID": "srn:reference-data/VerticalCRS:NAP:"
      },
      "FacilityID": "4be5df1b-7640-11e9-861e-b4d5bde9ee44",
      "WellboreDepth": [{
        "WellboreDepth": 1916,
        "WellboreDepthUnitOfMeasureID": "srn:reference-data/UnitOfMeasure:M:",
        "WellboreDepthTypeID": "srn:reference-data/WellboreDepthType:Total Depth:"
      }, {
        "WellboreDepth": 1916,
        "WellboreDepthUnitOfMeasureID": "srn:reference-data/UnitOfMeasure:M:",
        "WellboreDepthTypeID": "srn:reference-data/WellboreDepth:TVD:"
      }],
      "PreferredZeroDepthPoint": {
        "OffsetHeight": 4.5
      },
      "ShellStandardLegendTypeID": "srn:reference-data/ShellStandardLegendType:P and A oil and gas shows:",
      "SequenceNumber": 1,
      "IntialDrillingReasonTypeID": "srn:reference-data/DrillingReasonType:Exploratory:",
      "FacilityName": [{
        "FacilityNameTypeID": "srn:reference-data/FacilityNameType:Name:",
        "FacilityName": "WRM-01"
      }],
      "WellID": "srn:master-data/Well:2221:",
      "FacilityTypeID": "srn:reference-data/FacilityType:Wellbore:"
      }
    },
    "SRN": "srn:master-data/Wellbore:2221:"
  }
 ]
}
```

The following response body is given for a file request.

```json
{
  "UnprocessedSRNs": [],
  "Result": [{
    "FileLocation": {
      "SignedURL": "https://storage.googleapis.com/bucket/object?X-Goog-Algorithm=..."
    },
    "Data": {
      "GroupTypeProperties": {
        "OriginalFilePath": "http://gitlab.opengroup.org/osdu/open-test-data/tree/master/1-data/3-provided/tno/well-logs/8267_a0801_1996_comp.las"
        },
      "IndividualTypeProperties": {},
        "ExtensionProperties": {}
      },
      "SRN": "srn:file/las2:c589ade1b53111e99047c99b225c8828:1"
    }
  ]
}
```

### POST /getLocation

The `/getLocation` API endpoint creates a new location in the landing zone, such as a GCS bucket,
and returns it to the user so they upload a file for ingestion by that location.

#### Request body

| Property      | Type     | Description           |
| ------------- | -------- | --------------------- |
| FileID        | `String` | Unique ID of the file |

> **Note**: If a `FileID` isn't provided in the request, the Delivery service generates a
> Universally Unique Identifier (UUID) to be stored in `FileID`. If a `FileID` is provided and is
> already registered in the system, an error is returned.

> **Note**: The `FileID` must correspond to the regular expression: `^[\w,\s-]+(\.\w+)?$`.

Request example:

```sh
curl --location --request POST 'https://{path}/getLocation' \
    --header 'Authorization: Bearer {token}' \
    --header 'Content-Type: application/json' \
    --header 'Partition-Id: {DELFI partition ID}' \
    --data-raw '{
        "FileID": "8900a83f-18c6-4b1d-8f38-309a208779cc"
    }'
```

#### Response

The Delivery service returns the following data.

| Property  | Type     | Description                                           |
| --------- | -------- | ----------------------------------------------------- |
| FileID    | `String` | ID of the file to be ingested                         |
| Location  | `List`   | List of key-value pairs with cloud provider details to access the landing zone* |
| SignedURL | `String` | Signed URL by which the file to be ingested is stored |

> **Note**: The landing zone is a location in a cloud provider's platform where the user uploaded
> files for OSDU ingestion. The landing zone consists of the `Driver` and `Location` properties,
> which are stored in the database for each file upload request.

Response example:

```json
{
  "FileID": "file ID",
  "Location": {
      "SignedURL": "GCS signed URL"
  }
}
```

### POST /getFileLocation

The `/getFileLocation` API endpoint works similarly to `/getLocation`, but is internal and returns
the landing zone &mdash; `Location` and `Driver` &mdash; of a particular file instead of a signed
URL.

Once the OSDU security model is formulated and approved, the `/getFileLocation` API endpoint will
not be returning files that belong to other users.

#### Request body

| Property | Type     | Description                   |
| -------- | -------- | ----------------------------- |
| FileID   | `String` | ID of the file to be ingested |

Request example:

```sh
curl --location --request POST 'https://{path}/getFileLocation' \
    --header 'Authorization: Bearer {token}' \
    --header 'Content-Type: application/json' \
    --header 'Partition-Id: {assigned DELFI partition ID}' \
    --data-raw '{
        "FileID": "8900a83f-18c6-4b1d-8f38-309a208779cc"
    }'
```

#### Response

| Property | Type     | Description                                         |
| -------- | -------- | --------------------------------------------------- |
| Driver   | `String` | Description of the storage where the file is stored |
| Location | `String` | Direct URI to the file in storage                   |

### POST /getFileList

The `/getFileList` API endpoint allows auditing the attempted file uploads. The method is
unavailable for third-party applications.

The ingestion process depends on whether the client application uploaded a file or not. The
`/getFileList` endpoint is designed to let other OSDU services to inspect which user uploaded a
file, whether the file was uploaded to the landing zone, and whether the user started ingestion
after the file upload.

#### Request

| Property | Type       | Description                                 |
| -------- | ---------- | ------------------------------------------- |
| TimeFrom | `datetime` | Timestamp                                   |
| TimeTo   | `datetime` | Time interval for the CreatedAd filter      |
| PageNum  | `integer`  | The page number to return paginated results |
| Items    | `short`    | Pagination of the result                    |
| UserID   | `String`   | The ID of the user role or group            |

> **Note**: The `UserID` property isn't supported in the OSDU R2 Prototype.

Request example:

```sh
curl --location --request POST 'https://{path}/getFileList' \
    --header 'Authorization: Bearer {token}' \
    --header 'Partition-Id: {assigned DELFI partition ID}' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "PageNum": 0,
        "TimeFrom": "2020-01-01T16:21:00.552Z",
        "UserID": "common-user",
        "TimeTo": "2020-02-15T16:28:44.220Z",
        "Items": 2
    }'
```

### Response

A paginated result of the records stored in the database.

| Property         | Type      | Description                                      |
| ---------------- | --------- | ------------------------------------------------ |
| Content          | `List`    | List of file records retrieved from the database |
| Number           | `integer` | Some number                                      |
| NumberOfElements | `integer` | The amount of the returned records               |
| Size             | `short`   | The size of the Content list                     |

Each file record contains the following properties: `FileID`, `Driver`, `Location`, `CreatedAt`,
`CreatedBy`. For more information the returned properties, consult the [Firestore
collections](#firestore-collections) section.

Response example:

```json
{
    "Content": [
        {
            "FileID": "30a1ace6-1c8f-4f08-9982-2e9c5df8e878",
            "Driver": "GCS",
            "Location": "gs://osdu-temporary-files/common-user/1580461525198-2020-02-12-05-23-25-198/30a1ace6-1c8f-4f08-9982-2e9c5df8e878",
            "CreatedAt": "2020-02-12T05:24:25.198+0000",
            "CreatedBy": "common-user"
        },
        {
            "FileID": "da057da3-0fdb-41e4-afdc-3b63b812d484",
            "Driver": "GCS",
            "Location": "gs://osdu-temporary-files/common-user/1580461525198-2020-02-13-12-19-14-205/da057da3-0fdb-41e4-afdc-3b63b812d484",
            "CreatedAt": "2020-02-13T12:19:14.205+0000",
            "CreatedBy": "common-user"
        }
    ],
    "Number": 0,
    "NumberOfElements": 2,
    "Size": 2
}
```

## Service Provider Interfaces

The Delivery service has several Service Provider Interfaces that the classes need to implement.

| Interface              | Required/Optional       | Path                                                                     |
| ---------------------- | ----------------------- | ------------------------------------------------------------------------ |
| AuthenticationService  | Optional to implement   | `delivery-core/src/main/java/.../provider/interfaces/AuthenticationService`  |
| FileListService        | Optional to implement   | `delivery-core/src/main/java/.../provider/interfaces/FileListService`        |
| FileLocationRepository | Optional to implement   | `delivery-core/src/main/java/.../provider/interfaces/FileLocationRepository` |
| FileService            | Optional to implement   | `delivery-core/src/main/java/.../provider/interfaces/FileService`            |
| LocationMapper         | Obligatory to implement | `delivery-core/src/main/java/.../provider/interfaces/LocationMapper`         |
| LocationService        | Optional to implement   | `delivery-core/src/main/java/.../provider/interfaces/LocationService`        |
| StorageRepository      | Obligatory to implement | `delivery-core/src/main/java/.../provider/interfaces/StorageRepository`      |
| StorageService         | Obligatory to implement | `delivery-core/src/main/java/.../provider/interfaces/StorageService`         |
| ValidationService      | Optional to implement   | `delivery-core/src/main/java/.../provider/interfaces/ValidationService`      |

## GCP implementation

The GCP Identity and Access Management service account for the Delivery service must have the
`iam.serviceAccounts.signBlob` permission.

The predefined **Cloud Functions Service Agent**, **Cloud Run Service Agent**, and **Service Account
Token Creator** roles include the required permission.

For development purposes, it's recommended to create a separate service account.
It's enough to grant the **Service Account Token Creator** role to the development service account.

Obtaining user credentials for Application Default Credentials isn't suitable in this case because
signing a blob is only available with the service account credentials. Remember to set the
`GOOGLE_APPLICATION_CREDENTIALS` environment variable. Follow the [instructions on the Google
developer's portal][application-default-credentials].

### Persistence layer

The GCP implementation contains two mutually exclusive modules to work with the persistence layer.
Presently, OSDU R2 connects to legacy Cloud Datastore for compatibility with the current OpenDES
implementation. In the future OSDU releases, Cloud Datastore will be replaced by a Cloud Firestore
implementation that's already available in the project.

* The Cloud Datastore implementation is located in the **provider/delivery-gcp-datastore** folder.
* The Cloud Firestore implementation is located in the **provider/delivery-gcp** folder.

To learn more about available collections, follow to the [Firestore collections](#firestore-collections)
section.

## Datastore

The service account for Delivery service must have the `datastore.indexes.*` permissions. The
predefined **roles/datastore.indexAdmin** and **roles/datastore.owner** roles include the required
permission.

## Firestore collections

The GCP implementation of the Delivery service uses Cloud Firestore with the following collections
and indexes.

### `file-locations` collection

| Field     | Type     | Description                                                               |
| --------- | -------- | ------------------------------------------------------------------------- |
| FileID    | `Object` | Unique file ID that references a file data object with Driver, Location, CreatedAt, and CreatedBy |
| Driver    | `String` | Description of the storage where files were loaded                        |
| Location  | `String` | Direct URI to the file in storage                                         |
| CreatedAt | `String` | Time when the record was created                                          |
| CreatedBy | `String` | ID of the user that requested file location                               |

> **Note**: The `Location` value might be different from the signed URL returned to the user.
> **Note**: The `CreatedBy` property isn't supported in the OSDU R2 Prototype.

### Indexes

#### Single Field

| Collection ID  | Field path | Collection scope | Collection group scope |
| -------------- | ---------- | ---------------- | ---------------------- |
| file-locations | FileID     | _no changes_     | _no changes_           |

#### Composite

| Collection ID  | Fields                             | Query scope |
| -------------- | ---------------------------------- | ----------- |
| file-locations | `CreatedBy: ASC`, `CreatedAt: ASC` | Collection  |

[application-default-credentials]: https://developers.google.com/identity/protocols/application-default-credentials#calling
